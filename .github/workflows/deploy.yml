name: Deploy via SSH (Compose)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Connect and Deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22

          script: |
            echo "--- Starting Deployment ---"

            mkdir -p ~/my-app
            cd ~/my-app

            # Backup .env if exists
            if [ -f ".env" ]; then
              echo "Backing up .env file..."
              cp .env /tmp/.env.backup
            fi

            # Pull latest code
            if [ -d ".git" ]; then
              git fetch origin main
              git reset --hard origin/main
            else
              git clone ${{ github.server_url }}/${{ github.repository }} .
            fi

            # Restore .env
            if [ -f "/tmp/.env.backup" ]; then
              echo "Restoring .env file..."
              cp /tmp/.env.backup .env
              rm /tmp/.env.backup
            fi

            echo "Ensuring external networks exist..."

            docker network create monitoring_default || true
            docker network create erp-core-net || true
            docker network create backend-core-net || true

            echo "Deploying with docker compose..."

            docker compose down
            docker compose up -d --build

            echo "--- Deployment Complete ---"