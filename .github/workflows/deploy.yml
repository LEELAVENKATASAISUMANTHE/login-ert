name: ðŸš€ Deploy to Server (Docker Compose)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22

          script: |
            echo "==============================="
            echo "ðŸš€ Starting Deployment"
            echo "==============================="

            mkdir -p ~/my-app
            cd ~/my-app

            # Backup .env if exists
            if [ -f ".env" ]; then
              echo "Backing up existing .env..."
              cp .env /tmp/.env.backup
            fi

            # Pull latest code
            if [ -d ".git" ]; then
              echo "Fetching latest code..."
              git fetch origin main
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              git clone https://github.com/LEELAVENKATASAISUMANTHE/login-ert .
            fi

            # Restore .env
            if [ -f "/tmp/.env.backup" ]; then
              echo "Restoring .env file..."
              cp /tmp/.env.backup .env
              rm /tmp/.env.backup
            fi

            echo "Ensuring required Docker networks exist..."

            docker network create monitoring_default || true
            docker network create erp-core-net || true
            docker network create backend-core-net || true

            echo "Removing any old running-app container..."
            docker stop running-app || true
            docker rm running-app || true

            echo "Deploying using Docker Compose..."

            docker compose down || true
            docker compose up -d --build --force-recreate

            echo "==============================="
            echo "âœ… Deployment Complete"
            echo "==============================="